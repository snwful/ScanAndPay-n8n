# Session Log â€” 2025-08-27
- Date/Time: 2025-08-27 09:00 +07
- Actor: Codex

## Summary
Added idempotency columns and helper UPSERT for approvals table.

## Context / Goal
Implement idempotent approvals storage per architectural plan.

## Changes
- Files touched: docs/migrations/2025-08-27a_add_approvals_idem.sql, docs/migrations/2025-08-27b_backfill_approvals_idem.sql, docs/migrations/2025-08-27c_enforce_notnull_unique.sql, docs/migrations/2025-08-27d_fn_upsert_approval.sql, docs/postgres-schema.sql, docs/CHANGELOG.md
- Methods/Functions adjusted: fn_upsert_approval
- Data/Schema changes: approvals table now tracks source/idempotency_key with unique constraint

## Review Follow-up
- Hardened migrations with `IF NOT EXISTS` and `DO $$` guards
- Updated plan.md with PR reference

## Diffs & References
- See corresponding PR for full diff.
- Related docs updated: docs/CHANGELOG.md

## Tests / Validation
- `psql -v ON_ERROR_STOP=1 -f docs/migrations/2025-08-27*.sql` (shuffled order)
- Verified UPSERT updates `last_seen_at` on duplicate events

## Next Steps
- Integrate new UPSERT logic in ingestion workflows.

## Risks / Notes
- Ensure existing approvals rows have deterministic backfilled keys to avoid conflicts.
