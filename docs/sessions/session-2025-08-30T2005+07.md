# Session: 2025-08-30 20:05 +07

- Context: Fix gaps in Task 1/2 integration for approvals idempotency in v5.4 workflow and docs.
- Changes:
  - n8n v5.4: switch approvals dedupe to `(source,idempotency_key)` with `last_seen_at` refresh using CTE to preserve duplicate gating (`RETURNING session_token` only on first insert).
  - Docs: corrected UPSERT example to include `last_seen_at` in `INSERT` for `EXCLUDED.last_seen_at` to be valid.
- Files touched:
  - json/Tasker Ingest.v5.4.ai-openrouter.v3.json
  - docs/postgres-schema.sql
  - docs/CHANGELOG.md
- Test plan:
  - First event: PG node returns `session_token` → proceeds to update session and callback.
  - Duplicate event: PG node updates `last_seen_at` via CTE `upd` but returns no rows → duplicate branch logs metrics, no second callback.
- Rollback:
  - Restore previous query in v5.4 (`ON CONFLICT (session_token) DO NOTHING`) and previous doc lines.

